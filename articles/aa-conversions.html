<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="parquetize">
<title>Convert huge input file to parquet • parquetize</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Convert huge input file to parquet">
<meta property="og:description" content="parquetize">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">parquetize</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.7</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/aa-conversions.html">Convert huge input file to parquet</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ddotta/parquetize">
    <span class="fab fa fab fa-github fa-lg"></span>
     
    Contribute
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Convert huge input file to parquet</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ddotta/parquetize/blob/HEAD/vignettes/aa-conversions.Rmd" class="external-link"><code>vignettes/aa-conversions.Rmd</code></a></small>
      <div class="d-none name"><code>aa-conversions.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ddotta.github.io/parquetize/" class="external-link">parquetize</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="with-table_to_parquet">With <code>table_to_parquet()</code><a class="anchor" aria-label="anchor" href="#with-table_to_parquet"></a>
</h2>
<p>For <strong>huge input files in SAS, SPSS and Stata formats</strong>,
the parquetize package allows you to perform a clever conversion by
using <code>max_memory</code> or <code>max_rows</code> in the <a href="https://ddotta.github.io/parquetize/reference/table_to_parquet.html" class="external-link"><code>table_to_parquet()</code></a>
function. The native behavior of this function (and all other functions
in the package) is to load the entire table to be converted into R and
then write it to disk (in a single file or a partitioned directory).</p>
<p>When handling very large files, the risk that frequently occurs is
that the R session aborts because it cannot load the entire database
into memory. This risk is even more present if you work locally on your
computer and it can be limited if you work on remote servers.<br><strong><code><a href="../reference/table_to_parquet.html">table_to_parquet()</a></code> offers this solution which
answers a need expressed by parquetize users.</strong></p>
<table class="table"><tbody>
<tr class="odd">
<td><strong>The idea is to split the very large table into “chunks”
based on memory consumption of input data or on the number of rows in
the table in order to be able to simultaneously :</strong></td>
</tr>
<tr class="even">
<td>- <strong>read a chunk of the very large database</strong>
</td>
</tr>
<tr class="odd">
<td>- <strong>write this chunk in the floor file</strong>
</td>
</tr>
</tbody></table>
<p>Here are examples from the documentation using the iris table.
There’s two ways to split output files :</p>
<ul>
<li>by memory consumption</li>
<li>by number of lines</li>
</ul>
<div class="section level3">
<h3 id="spliting-data-by-memory-consumption">Spliting data by memory consumption<a class="anchor" aria-label="anchor" href="#spliting-data-by-memory-consumption"></a>
</h3>
<p><code>table_to_parquet</code> can guess the number of lines to put in
a file based on the memory consuption with the argument
<code>max_memory</code> expressed in Mb.</p>
<p>Here we cut the 150 rows into chunks of roughly 5 Kb when a file is
loaded as a tibble.<br>
In this example we get 2 parquet files of 89 lines called
<code>iris1-89.parquet</code> and <code>iris90-150.parquet</code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/table_to_parquet.html">table_to_parquet</a></span><span class="op">(</span></span>
<span>  path_to_file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples"</span>, <span class="st">"iris.sas7bdat"</span>, package <span class="op">=</span> <span class="st">"haven"</span><span class="op">)</span>,</span>
<span>  path_to_parquet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_memory <span class="op">=</span> <span class="fl">5</span> <span class="op">/</span> <span class="fl">1024</span>,</span>
<span>  encoding <span class="op">=</span> <span class="st">"utf-8"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading data...</span></span>
<span><span class="co">#&gt; Writing file181e5aa590b5-1-89.parquet...</span></span>
<span><span class="co">#&gt; Reading data...</span></span>
<span><span class="co">#&gt; Writing file181e5aa590b5-90-150.parquet...</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Data are available in parquet dataset under /tmp/RtmpZqCBp9/file181e5aa590b5/</span></span>
<span><span class="co">#&gt; Writing file181e5aa590b5-90-150.parquet...</span></span></code></pre></div>
<p>In real life, you should use a <code>max_memory</code> in the Gb
range, for example with a SAS file of 50 000 000 lines and using
<code>max_memory</code> of 5000 Mb :</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="../reference/table_to_parquet.html">table_to_parquet</a></span><span class="op">(</span></span>
<span>  path_to_file <span class="op">=</span> <span class="st">"myhugefile.sas7bdat"</span>,</span>
<span>  path_to_parquet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_memory <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  encoding <span class="op">=</span> <span class="st">"utf-8"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="splitting-data-by-number-of-lines">Splitting data by number of lines<a class="anchor" aria-label="anchor" href="#splitting-data-by-number-of-lines"></a>
</h3>
<blockquote>
<p>Tip: The number of lines that each chunk must contain must be
supported by the RAM of your computer/server. Ideally, the number of
chunks to be defined must be limited. It should be in tens and not
hundreds to limit the number of intermediate files (see example
below).</p>
</blockquote>
<p>Here we cut the 150 rows into 3 chunks of 50 rows. In this example we
get 3 parquet files of 50 lines called <code>iris1-50.parquet</code>,
<code>iris51-100.parquet</code> and <code>iris101-151.parquet</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/table_to_parquet.html">table_to_parquet</a></span><span class="op">(</span></span>
<span>  path_to_file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples"</span>, <span class="st">"iris.sas7bdat"</span>, package <span class="op">=</span> <span class="st">"haven"</span><span class="op">)</span>,</span>
<span>  path_to_parquet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_rows <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  encoding <span class="op">=</span> <span class="st">"utf-8"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In real life, we can perform this kind of request with the parquetize
API (for example with a SAS file of 50 000 000 lines and defining 25
chunks of 2 000 000 rows each) :</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/table_to_parquet.html">table_to_parquet</a></span><span class="op">(</span></span>
<span>  path_to_file <span class="op">=</span> <span class="st">"myhugefile.sas7bdat"</span>,</span>
<span>  path_to_parquet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_rows <span class="op">=</span> <span class="fl">2000000</span>,</span>
<span>  encoding <span class="op">=</span> <span class="st">"utf-8"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Files <code>myhugefile1-2000000.parquet</code>,
<code>myhugefile2000001-4000000.parquet</code> … will be created.</p>
</div>
</div>
<div class="section level2">
<h2 id="function-rbind_parquet">Function <code>rbind_parquet()</code><a class="anchor" aria-label="anchor" href="#function-rbind_parquet"></a>
</h2>
<p>If at the end of the conversion with <code><a href="../reference/table_to_parquet.html">table_to_parquet()</a></code>,
<strong>you want to reconstitute a unique initial table</strong> and
<strong>if you have the computer resources (in RAM) to do so</strong>,
you can use the helper function provided with the API of
<code><a href="../reference/rbind_parquet.html">rbind_parquet()</a></code>.<br>
This function allows to bind multiple parquet files by row.<br>
Here’s an example without deleting initial files
(<code>delete_initial_files</code>=FALSE) :</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rbind_parquet.html">rbind_parquet</a></span><span class="op">(</span></span>
<span>  folder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  output_name <span class="op">=</span> <span class="st">"myhugefile"</span>,</span>
<span>  delete_initial_files <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>myhugefile.parquet</code> file will be created from the
<code>myhugefile1-2000000.parquet</code>,
<code>myhugefile2000001-4000000.parquet</code>… files!</p>
</div>
<div class="section level2">
<h2 id="alternatives-to-parquetize">Alternatives to <code>{parquetize}</code><a class="anchor" aria-label="anchor" href="#alternatives-to-parquetize"></a>
</h2>
<p>Despite our best efforts, you may not be able to convert your very
large database with {parquetize}.<br>
In this case, one solution is probably to turn to <a href="https://github.com/duckdb/duckdb-r" class="external-link">duckdb</a>, which offers
undeniable advantages when it comes to conversion operations.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Damien Dotta, Nicolas Chuche.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
